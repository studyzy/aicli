# 功能规范: 自然语言命令行转换工具

**功能分支**: `001-nl-to-cmd`
**创建时间**: 2026-01-12
**状态**: 草稿
**输入**: 用户描述: "这是一个让命令行支持自然语言进行操作的命令行工具，用户只需要输入自然语言，就通过连接到LLM转换为实际的命令，然后返回的执行命令。如：\"aicli 查找log.txt中的ERROR日志\"就好被LLM转换为 grep \"ERROR\" log.txt并执行。该命令支持标准输入输出，以便管道符使用"

## 用户场景与测试 *(必填)*

### 用户故事 1 - 基础自然语言命令转换与执行 (优先级: P1)

作为命令行用户，我希望使用自然语言描述我想执行的操作，系统自动将其转换为命令并执行，这样我就不需要记住复杂的命令语法。

**优先级原因**: 这是核心功能，是整个工具存在的基础价值。用户能够通过自然语言完成基本的文件操作和系统命令，可以立即验证工具的可用性。

**独立测试**: 可以通过输入简单的自然语言命令（如"查找文件"、"显示当前目录"）完全测试并交付核心价值，无需其他功能支持。

**验收场景**: 

1. **给定** 用户在命令行中，**当** 输入 `aicli 查找log.txt中的ERROR日志` 时，**那么** 系统应该调用 LLM 将其转换为 `grep "ERROR" log.txt` 并执行该命令，显示结果
2. **给定** 用户在命令行中，**当** 输入 `aicli 显示当前目录下所有txt文件` 时，**那么** 系统应该转换为类似 `ls *.txt` 或 `find . -name "*.txt"` 的命令并执行
3. **给定** 用户输入的自然语言描述不明确，**当** LLM 无法准确转换时，**那么** 系统应该显示可能的命令选项供用户选择
4. **给定** 转换后的命令可能有风险（如删除操作），**当** 即将执行时，**那么** 系统应该先显示命令并要求用户确认

---

### 用户故事 2 - 标准输入输出与管道符支持 (优先级: P2)

作为高级命令行用户，我希望 aicli 能够支持管道符和标准输入输出，这样我可以将其与其他命令组合使用，构建更复杂的工作流。

**优先级原因**: 支持管道符是命令行工具的重要特性，能够让 aicli 融入现有的命令行工作流，显著提升工具的实用性和灵活性。

**独立测试**: 可以通过将 aicli 与 cat、echo 等标准命令通过管道组合使用来独立测试，验证数据流转是否正确。

**验收场景**: 

1. **给定** 用户需要处理管道输入，**当** 执行 `cat log.txt | aicli 过滤出包含ERROR的行` 时，**那么** aicli 应该从标准输入读取内容，转换为过滤命令并输出结果
2. **给定** 用户需要链式处理，**当** 执行 `aicli 列出所有txt文件 | grep important` 时，**那么** aicli 的输出应该能被后续命令正确接收
3. **给定** 用户提供标准输入数据，**当** aicli 处理时，**那么** 应该将标准输入内容作为上下文传递给 LLM 以生成更准确的命令

---

### 用户故事 3 - 交互式命令确认与历史记录 (优先级: P3)

作为谨慎的用户，我希望在执行危险命令前能够预览并确认，同时能够查看之前执行过的命令历史，这样我可以更安全地使用工具并从历史中学习。

**优先级原因**: 安全性和可追溯性对于命令行工具很重要，但不是 MVP 的必需功能。这个功能提升用户信任度和使用体验。

**独立测试**: 可以通过执行删除、移动等潜在危险操作来测试确认机制，通过查询历史命令来测试记录功能。

**验收场景**: 

1. **给定** 用户输入可能的危险操作，**当** aicli 识别出删除、移动、修改等危险命令时，**那么** 系统应该显示将要执行的命令并等待用户输入 y/n 确认
2. **给定** 用户已执行多个命令，**当** 输入 `aicli --history` 时，**那么** 系统应该显示最近执行的自然语言输入、转换后的命令及执行结果
3. **给定** 用户想重新执行历史命令，**当** 使用 `aicli --retry <编号>` 时，**那么** 系统应该重新执行对应的命令

---

### 边界情况

- 当用户输入的自然语言过于模糊或不完整时，系统应该提示用户提供更多信息或显示多个可能的命令选项
- 当 LLM 服务不可用或超时时，系统应该显示友好的错误信息并建议用户稍后重试
- 当转换后的命令语法错误时，系统应该捕获错误并显示错误信息，而不是直接崩溃
- 当用户输入包含敏感信息（如密码、密钥）时，系统应该在发送给 LLM 前进行脱敏处理或警告用户
- 当命令执行时间过长时，系统应该支持用户中断（Ctrl+C）
- 当同时收到标准输入和命令行参数时，系统应该合理处理优先级（命令行参数作为主要意图，标准输入作为数据源）

## 需求 *(必填)*

### 功能需求

- **FR-001**: 系统必须接受用户通过命令行参数输入的自然语言描述
- **FR-002**: 系统必须能够连接到配置的 LLM 服务（支持多种 LLM 提供商）
- **FR-003**: 系统必须将用户的自然语言描述发送给 LLM，并接收转换后的命令
- **FR-004**: 系统必须在用户当前的 shell 环境中执行转换后的命令
- **FR-005**: 系统必须将命令执行结果输出到标准输出（stdout）
- **FR-006**: 系统必须将错误信息输出到标准错误（stderr）
- **FR-007**: 系统必须支持从标准输入（stdin）读取数据
- **FR-008**: 系统必须支持通过管道符与其他命令组合使用
- **FR-009**: 系统必须能够检测潜在的危险命令（删除、格式化、修改系统配置等）
- **FR-010**: 系统必须在执行危险命令前显示命令内容并要求用户确认
- **FR-011**: 系统必须提供配置文件或环境变量方式配置 LLM API 密钥和端点
- **FR-012**: 系统必须记录每次命令转换和执行的日志（可选开启）
- **FR-013**: 系统必须处理 LLM 服务的网络错误、超时和限流情况
- **FR-014**: 系统必须提供 `--dry-run` 选项，仅显示转换后的命令而不执行
- **FR-015**: 系统必须提供 `--verbose` 选项，显示详细的转换和执行过程

### 关键实体

- **自然语言输入**: 用户通过命令行提供的自然语言描述，包含用户想要执行的操作意图
- **转换后命令**: LLM 根据自然语言输入生成的实际 shell 命令字符串
- **执行上下文**: 包括当前工作目录、环境变量、标准输入数据等执行命令所需的上下文信息
- **LLM 配置**: 包括 API 端点、密钥、模型名称、超时时间等连接 LLM 服务所需的配置信息
- **命令历史记录**: 包含时间戳、自然语言输入、转换后命令、执行状态、输出结果等信息的历史记录条目

## 成功标准 *(必填)*

### 可衡量的结果

- **SC-001**: 用户能够在 5 秒内通过自然语言完成基本的文件查找、内容搜索操作（包括 LLM 响应和命令执行时间）
- **SC-002**: 系统支持至少 95% 的常见命令行操作场景（文件操作、文本处理、系统信息查询）
- **SC-003**: 当 LLM 转换的命令准确度达到 90% 以上时（即用户无需修改可直接使用），用户满意度显著提升
- **SC-004**: 用户能够在 3 次以内的尝试中完成复杂的多步操作（通过管道符组合）
- **SC-005**: 系统在 LLM 服务故障时能够在 2 秒内返回友好的错误提示，不会挂起或崩溃
- **SC-006**: 危险命令（删除、格式化等）100% 触发用户确认机制，防止误操作
- **SC-007**: 工具的学习成本低于 10 分钟（用户从安装到成功执行第一个命令）
- **SC-008**: 命令执行成功率达到 95% 以上（排除用户取消和 LLM 误判的情况）

## 假设与依赖

### 假设

- 用户已经安装并配置了至少一个可访问的 LLM 服务（如 OpenAI API、本地 LLM 等）
- 用户具备基本的命令行使用经验，理解标准输入输出的概念
- 用户的系统支持执行 shell 命令（Unix-like 系统或 Windows 的 PowerShell/CMD）
- 用户理解自然语言转换可能存在误差，需要在执行前确认关键操作
- LLM 服务的响应时间在合理范围内（通常小于 3 秒）

### 外部依赖

- LLM 服务 API（OpenAI、Anthropic、本地模型等）
- 用户操作系统的 shell 环境（bash、zsh、PowerShell 等）
- 网络连接（如果使用云端 LLM 服务）
- 系统权限（执行某些命令可能需要特定权限）

### 约束

- 必须遵循项目章程要求：60% 以上单元测试覆盖率，中文文档和注释
- LLM API 调用可能产生费用，需要合理控制调用频率和内容长度
- 隐私保护：敏感信息不应发送到云端 LLM 服务
- 跨平台兼容性：需要支持 Linux、macOS 和 Windows 系统

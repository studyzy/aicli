# 功能规范:国际化核心功能(i18n)

## 新增需求

### 需求:语言检测

系统必须能够自动检测用户的语言偏好,优先级为:配置文件 > 环境变量 > 默认值。

#### 场景:从配置文件读取语言设置
- **当** 用户在 `~/.aicli.json` 中设置了 `"language": "en"`
- **那么** 系统应使用英文作为界面语言
- **并且** 忽略操作系统环境变量

#### 场景:从环境变量检测语言
- **当** 配置文件中未设置 `language` 字段
- **并且** 环境变量 `LANG` 设置为 `en_US.UTF-8`
- **那么** 系统应解析出语言代码 `en` 并使用英文

#### 场景:使用默认语言
- **当** 配置文件和环境变量都未设置语言
- **那么** 系统应默认使用中文(`zh`)
- **并且** 保持与当前版本的用户体验一致

#### 场景:支持常见 locale 格式
- **当** 环境变量为以下任一格式:`zh_CN.UTF-8`, `zh_CN`, `zh`, `en_US.UTF-8`, `en_US`, `en`
- **那么** 系统应正确解析出语言代码(`zh` 或 `en`)
- **并且** 忽略地区和编码后缀

### 需求:翻译文本查找

系统必须提供根据翻译键获取对应语言文本的功能。

#### 场景:查找存在的翻译键
- **当** 调用 `T("error.load_config")` 且当前语言为英文
- **那么** 系统应返回英文翻译文本 `"Failed to load configuration"`

#### 场景:翻译键不存在时的 fallback
- **当** 调用 `T("non.existent.key")`
- **那么** 系统应返回翻译键本身(`"non.existent.key"`)作为 fallback
- **并且** 不抛出错误,保证程序继续运行

#### 场景:带参数的翻译文本
- **当** 调用 `T("msg.history_count", 10)` 且当前语言为中文
- **那么** 系统应返回格式化后的文本 `"历史记录(共 10 条)"`
- **并且** 使用 `fmt.Sprintf` 风格的参数替换

### 需求:翻译资源管理

系统必须以轻量级方式管理翻译资源,所有翻译文本编译到二进制中。

#### 场景:加载中文翻译资源
- **当** 系统初始化且语言为中文
- **那么** 应加载 `messages_zh.go` 中定义的翻译 map
- **并且** 翻译文本在编译期嵌入二进制,无需外部资源文件

#### 场景:加载英文翻译资源
- **当** 系统初始化且语言为英文
- **那么** 应加载 `messages_en.go` 中定义的翻译 map
- **并且** 所有中文文本的对应英文翻译都已定义

#### 场景:翻译完整性检查
- **当** 开发者添加新的翻译键
- **那么** 必须同时在 `messages_zh.go` 和 `messages_en.go` 中添加对应翻译
- **并且** 单元测试应验证两种语言的翻译键一致性

### 需求:向后兼容性

国际化功能的引入必须不破坏现有功能和配置。

#### 场景:旧配置文件兼容
- **当** 用户使用旧版本的 `~/.aicli.json`(不包含 `language` 字段)
- **那么** 系统应正常加载配置,无错误
- **并且** 自动检测系统语言

#### 场景:中文用户体验不变
- **当** 用户在中文系统环境下运行 aicli
- **并且** 配置文件中未显式设置语言
- **那么** 所有界面文本应显示中文
- **并且** 与旧版本行为完全一致

### 需求:性能要求

翻译查找必须高效,不影响命令执行性能。

#### 场景:翻译查找性能
- **当** 系统执行翻译文本查找
- **那么** 单次查找耗时应 <1 微秒
- **并且** 使用 Go map 进行 O(1) 查找

#### 场景:二进制体积控制
- **当** 编译包含国际化功能的二进制文件
- **那么** 相比旧版本的二进制体积增长应 <100KB
- **并且** 通过 CI 检查验证体积增长

### 需求:可扩展性

国际化架构必须支持未来添加更多语言。

#### 场景:添加新语言的流程
- **当** 需要添加日语支持
- **那么** 应只需创建 `messages_ja.go` 文件
- **并且** 在语言检测逻辑中添加 `ja` 语言代码映射
- **并且** 无需修改核心 i18n 逻辑

#### 场景:不支持的语言 fallback
- **当** 用户系统语言为 `fr`(法语,当前未支持)
- **那么** 系统应 fallback 到默认语言(中文)
- **并且** 在 verbose 模式下输出警告信息
